<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Notika - Search Notes</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap"
            rel="stylesheet"
        />
        <script src="https://unpkg.com/lucide@latest"></script>
        {% load static %}
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                font-family: "Poppins", sans-serif;
                background: #f5e1c8;
                display: flex;
                height: 100vh;
                color: #4a2e1e;
                transition:
                    background 0.3s,
                    color 0.3s;
            }
            aside {
                background: #e0cbb5;
                width: 220px;
                padding: 20px;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                transition:
                    background 0.3s,
                    color 0.3s;
                color: #4a2e1e;
            }
            aside nav {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            aside nav a {
                text-decoration: none;
                color: inherit;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 20px;
                transition: color 0.3s;
            }
            aside nav a:hover {
                color: #8b5e3b;
            }
            .nav-button { background: none; border: none; color: inherit; font-weight: 500; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 16px; text-decoration: none; transition: color 0.3s; }
            .nav-button:hover { color: #8b5e3b; }
            body.dark-mode .nav-button:hover { color: #e3d8b0; }
            .logout-button { color: #dc3545; }
            .logout-button:hover { color: #c82333; }
            body.dark-mode .logout-button { color: #ff6b6b; }
            body.dark-mode .logout-button:hover { color: #ff5252; }
            .profile {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: auto;
            }
            .profile img {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: 2px solid transparent;
                transition: border-color 0.3s;
            }
            .main {
                flex: 1;
                padding: 30px;
                overflow-y: auto;
                transition:
                    background 0.3s,
                    color 0.3s;
            }
            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
            }
            .welcome {
                color: #8b5e3b;
                font-size: 26px;
                font-weight: 600;
                transition: color 0.3s;
            }
            .search-box input {
                padding: 12px;
                font-size: 16px;
                border: 1px solid #c4a484;
                border-radius: 10px;
                width: 100%;
                max-width: 400px;
                background: #fff8f0;
                color: #4a2e1e;
                transition:
                    background 0.3s,
                    border-color 0.3s,
                    color 0.3s;
            }
            .search-box input:focus {
                outline: none;
                box-shadow: 0 0 0 3px #e2cba766;
            }
            .notes-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 20px;
                margin-top: 30px;
            }
            .note {
                background: #fff8f0;
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
                display: flex;
                flex-direction: column;
                gap: 10px;
                position: relative;
                height: 180px;
                color: #4a2e1e;
                transition:
                    background 0.3s,
                    color 0.3s,
                    box-shadow 0.3s;
            }
            .note span {
                font-weight: 500;
                color: inherit;
                margin-bottom: 5px;
            }
            .tag {
                display: inline-block;
                background: #d9b98c;
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 12px;
                width: fit-content;
                margin-bottom: 10px;
                transition: background 0.3s;
            }
            .note-footer {
                position: absolute;
                bottom: 15px;
                left: 15px;
                display: flex;
                gap: 8px;
                align-items: center;
            }
            .icon-btn {
                background: #8b5e3b;
                color: white;
                border: none;
                width: 36px;
                height: 36px;
                padding: 0;
                border-radius: 10px;
                cursor: pointer;
                transition: background 0.2s ease, transform 0.08s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            }
            .icon-btn:hover { background: #6a4229; }
            .icon-btn:active { transform: translateY(1px); }
            .icon-btn svg { width: 18px; height: 18px; stroke: white; }
            .icon-btn.is-fav { background: #e3d8b0; color: #2a2a2a; }
            .empty-state {
                text-align: center;
                margin-top: 60px;
                color: #a3825a;
                font-size: 18px;
                transition: color 0.3s;
            }
            .empty-state img {
                max-width: 180px;
                margin-bottom: 20px;
                filter: none;
                transition: filter 0.3s;
            }
            #previewModal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                align-items: center;
                justify-content: center;
            }
            #previewModal .modal-content {
                background: #fff8f0;
                padding: 30px;
                border-radius: 12px;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                position: relative;
                color: #4a2e1e;
                transition:
                    background 0.3s,
                    color 0.3s;
            }
            #previewModal h3 {
                margin-top: 0;
                color: #8b5e3b;
                transition: color 0.3s;
            }
            #previewModal p,
            #previewModal pre {
                color: #4a2e1e;
                transition: color 0.3s;
            }
            #previewModal button {
                background: #8b5e3b;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                margin-top: 20px;
                cursor: pointer;
                transition: background 0.3s;
            }
            #previewModal button:hover {
                background: #6a4229;
            }
            .pdf-preview {
                width: 100%;
                height: 400px;
            }
            .profile a.user-link { text-decoration: none; color: #4a2e1e; display: flex; align-items: center; gap: 10px; font-weight: 500; padding: 8px 0; transition: color 0.3s; }

            .profile a.user-link:hover {
                color: #8b5e3b;
            }
            /* Dark mode styles */
            body.dark-mode {
                background: #1c1c1c;
                color: #f5e1c8;
            }
            body.dark-mode aside {
                background: #2b2b2b;
                color: #f5e1c8;
                box-shadow: 2px 0 15px rgba(255 255 255 / 0.1);
            }
            body.dark-mode aside nav a {
                color: #f5e1c8;
            }
            body.dark-mode aside nav a:hover {
                color: #e3d8b0;
            }
            body.dark-mode .profile img {
                border-color: #e3d8b0;
            }
            body.dark-mode .main {
                background: #292929;
                color: #f5e1c8;
            }
            body.dark-mode .welcome {
                color: #e3d8b0;
            }
            body.dark-mode .search-box input {
                background: #3a3a3a;
                border-color: #6f6f6f;
                color: #f5e1c8;
            }
            body.dark-mode .search-box input:focus {
                box-shadow: 0 0 0 3px #e3d8b033;
            }
            body.dark-mode .note {
                background: #3a3a3a;
                box-shadow: 0 2px 15px rgba(255 255 255 / 0.05);
                color: #f5e1c8;
            }
            body.dark-mode .tag {
                background: #8b6c3b;
                color: #f0e9cf;
            }
            body.dark-mode .icon-btn { background: #e3d8b0; color: #2a2a2a; }
            body.dark-mode .icon-btn:hover { background: #c3b37a; }
            body.dark-mode .icon-btn svg { stroke: #2a2a2a; }
            body.dark-mode .empty-state {
                color: #a69e85;
            }
            body.dark-mode .empty-state img {
                filter: brightness(0.7) contrast(1.2);
            }
            body.dark-mode #previewModal .modal-content {
                background: #3a3a3a;
                color: #f5e1c8;
                box-shadow: 0 4px 25px rgba(255 255 255 / 0.1);
            }
            body.dark-mode #previewModal h3 {
                color: #e3d8b0;
            }
            body.dark-mode #previewModal button {
                background: #e3d8b0;
                color: #2a2a2a;
            }
            body.dark-mode #previewModal button:hover {
                background: #c3b37a;
            }
            body.dark-mode .profile a.user-link {
                color: #f5e1c8;
            }
            body.dark-mode .profile a.user-link:hover {
                color: #e3d8b0;
            }
            /* Dark mode toggle button */
            .dark-toggle {
                cursor: pointer;
                background: transparent;
                border: none;
                color: inherit;
                font-size: 20px;
                padding: 6px;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.3s;
            }
            .dark-toggle:hover {
                background: rgba(0, 0, 0, 0.1);
            }
        </style>
    </head>
    <body>
        <!-- Sidebar -->
        {% include 'partials/sidebar.html' %}

        <!-- Main Content -->
        <div class="main">
            <header>
                <div class="welcome">Search Notes</div>
                <div class="search-box">
                    <input
                        type="text"
                        id="resultsSearchInput"
                        placeholder="Search..."
                        onkeyup="if(event.key==='Enter'){ doSearchFromResults(); }"
                    />
                </div>
            </header>

            <div id="searchResults" class="notes-grid">
                {% if results %}
                    {% for doc in results %}
                        <div class="note">
                            <span>{{ doc.title }}</span>
                            <div class="tag">{{ doc.course.name }}</div>
                            <div class="note-footer">
                                <a class="icon-btn" href="{% url 'core:download' doc.id %}" title="Download">
                                <!-- <button -->
                                <!--     class="icon-btn" -->
                                <!--     onclick="downloadNote('Math Notes - Algebra.pdf')" -->
                                <!--     title="Download" -->
                                <!-- > -->
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="24"
                                        height="24"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        data-lucide="download"
                                        class="lucide lucide-download"
                                    >
                                        <path d="M12 15V3"></path>
                                        <path
                                            d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                                        ></path>
                                        <path d="m7 10 5 5 5-5"></path>
                                    </svg>
                                <!-- </button> -->
                                </a>
                                <button class="icon-btn" onclick="toggleFavorite({{ doc.id }}, this)" title="Favorite">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="24"
                                        height="24"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        data-lucide="heart"
                                        class="lucide lucide-heart"
                                    >
                                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                                    </svg>
                                </button>
                                <button class="icon-btn" onclick="showDetails({{ doc.id }})" title="Show details">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="eye" class="lucide lucide-eye"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            {% if not results %}
            <div class="empty-state" id="emptyState">
                <p>No matching notes found for “{{ query }}”.</p>
            </div>
            {% endif %}
        </div>

        <!-- Preview Modal -->
        <div id="previewModal">
            <div class="modal-content">
                <h3>Note Details</h3>
                <div id="previewContent"></div>
                <div style="display:flex; gap:8px; margin-top:12px;">
                    <a id="modalDownload" class="icon-btn" href="#" title="Download">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="download" class="lucide lucide-download"><path d="M12 15V3"></path><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><path d="m7 10 5 5 5-5"></path></svg>
                    </a>
                    <button id="modalFavorite" class="icon-btn" title="Favorite">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="heart" class="lucide lucide-heart"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                    </button>
                    <button onclick="closePreview()" class="icon-btn" title="Close">Close</button>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script>
            const container = document.getElementById("searchResults");
            const emptyState = document.getElementById("emptyState");
            const darkToggle = document.querySelector(".dark-toggle");
            const body = document.body;

            function doSearchFromResults() {
                const input = document.getElementById('resultsSearchInput');
                const value = (input?.value || '').trim();
                if (value) {
                    window.location.href = `/search-results?q=${encodeURIComponent(value)}`;
                }
            }

            function downloadNote(name) {}

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            async function addFavorite(docId) {
                const csrftoken = getCookie('csrftoken');
                try {
                    const res = await fetch('/favorite/add', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
                        body: new URLSearchParams({ doc_id: String(docId) })
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert(data.created ? 'Added to favorites' : 'Already in favorites');
                    } else {
                        alert('Failed: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    alert('Network error');
                }
            }
            function previewNote(name, type) {
                const previewBox = document.getElementById("previewContent");
                const filePath = `./path/to/notes/${name}`;

                if (type === "pdf") {
                    previewBox.innerHTML = `<iframe class="pdf-preview" src="${filePath}" frameborder="0"></iframe>`;
                } else if (type === "txt") {
                    previewBox.innerHTML = `<pre>${getSampleText(filePath)}</pre>`;
                } else {
                    previewBox.innerHTML = `<p>Preview not available for this file type.</p>`;
                }
                document.getElementById("previewModal").style.display = "flex";
            }

            // Dummy function for txt preview
            function getSampleText() {
                return "Sample text preview not implemented in this demo.";
            }

            function closePreview() {
                document.getElementById("previewModal").style.display = "none";
            }

            function likeNote(name) {}

            function updateFavIcon(buttonEl, isFav) {
                if (!buttonEl) return;
                buttonEl.style.background = isFav ? '#e3d8b0' : '#8b5e3b';
            }

            async function toggleFavorite(docId, buttonEl) {
                const csrftoken = getCookie('csrftoken');
                try {
                    const res = await fetch('/favorite/toggle', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
                        body: new URLSearchParams({ doc_id: String(docId) })
                    });
                    const data = await res.json();
                    if (data.success) {
                        updateFavIcon(buttonEl, data.is_favorite);
                    }
                } catch (e) {}
            }

            async function showDetails(docId) {
                try {
                    const res = await fetch(`/document/${docId}/info`);
                    const d = await res.json();
                    const kb = Math.round((d.size || 0) / 1024);
                    const html = `
                        <div>
                          <div><strong>Title:</strong> ${d.title || ''}</div>
                          <div><strong>Description:</strong> ${d.description || ''}</div>
                          <div><strong>Course:</strong> ${d.course || ''}</div>
                          <div><strong>File:</strong> ${d.file_name || ''}</div>
                          <div><strong>Extension:</strong> ${d.extension || ''}</div>
                          <div><strong>Size:</strong> ${kb} KB</div>
                          <div><strong>Downloads:</strong> ${d.downloads}</div>
                        </div>
                    `;
                    document.getElementById('previewContent').innerHTML = html;
                    const dl = document.getElementById('modalDownload');
                    dl.href = d.download_url;
                    const favBtn = document.getElementById('modalFavorite');
                    updateFavIcon(favBtn, !!d.is_favorite);
                    favBtn.onclick = () => toggleFavorite(docId, favBtn);
                    document.getElementById('previewModal').style.display = 'flex';
                } catch (e) {}
            }

            // Dark mode toggle logic - use consistent implementation
            function toggleDarkMode() {
                const body = document.body;
                body.classList.toggle("dark-mode");

                const isDark = body.classList.contains("dark-mode");
                localStorage.setItem("theme", isDark ? "dark" : "light");

                const darkToggle = document.querySelector('.toggle-dark');
                if (darkToggle) {
                    darkToggle.innerHTML = isDark ? '<i data-lucide="sun"></i> Light Mode' : '<i data-lucide="moon"></i> Dark Mode';
                    if (window.lucide) lucide.createIcons();
                }
            }

            // Initialize theme on page load
            const savedTheme = localStorage.getItem("theme");
            if (savedTheme === "dark") {
                document.body.classList.add("dark-mode");
                const darkToggle = document.querySelector('.toggle-dark');
                if (darkToggle) {
                    darkToggle.innerHTML = '<i data-lucide="sun"></i> Light Mode';
                    if (window.lucide) lucide.createIcons();
                }
            }

            // Add event listener when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                const darkToggle = document.querySelector('.toggle-dark');
                if (darkToggle) {
                    darkToggle.addEventListener('click', toggleDarkMode);
                }
            });
        </script>
    </body>
</html>
